unit UnitLetters;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ComCtrls, Vcl.StdCtrls, Vcl.DBCtrls,
  Data.DB, Vcl.Grids, Vcl.DBGrids, Vcl.Mask, mySQLDbTables,UnitLettersChange,idFTP,
  Vcl.Menus;

type
  TFormLetters = class(TForm)
    PageControl1: TPageControl;
    TabSheet1: TTabSheet;
    TabSheet2: TTabSheet;
    ComboBoxOutGoing: TComboBox;
    GroupBox1: TGroupBox;
    DBGridOutgoing: TDBGrid;
    MySQLDatabaseLetters: TMySQLDatabase;
    GroupBox2: TGroupBox;
    ComboBoxIncoming: TComboBox;
    DBGridIncoming: TDBGrid;
    ButtonIncoming: TButton;
    ButtonOutGoing: TButton;
    GroupBox3: TGroupBox;
    DBGridOutGoingFile: TDBGrid;
    GroupBox4: TGroupBox;
    DBGrid3: TDBGrid;
    DataSourceOutGoing: TDataSource;
    DataSourceOutGoingFile: TDataSource;
    PopupMenuOutGoing: TPopupMenu;
    N1: TMenuItem;
    N2: TMenuItem;
    EditoutGoingSearch: TEdit;
    PopupMenuOutGoingFile: TPopupMenu;
    N3: TMenuItem;
    N4: TMenuItem;
    N5: TMenuItem;
    N6: TMenuItem;
    N7: TMenuItem;
    N8: TMenuItem;
    EditIncomingSearch: TEdit;
    DataSourceIncoming: TDataSource;
    procedure FormCreate(Sender: TObject);
    procedure ListOutGoingView();
    procedure ListIncomingView();
    procedure ButtonOutGoingClick(Sender: TObject);
    procedure ComboBoxOutGoingChange(Sender: TObject);
    procedure ButtonIncomingClick(Sender: TObject);
    procedure DBGridOutgoingCellClick(Column: TColumn);
    procedure OutGoingChangeStatus(number : integer);
    procedure OutGoingFileView();
    procedure DBGridIncomingView();
    procedure N1Click(Sender: TObject);
    procedure N2Click(Sender: TObject);
    procedure EditoutGoingSearchChange(Sender: TObject);
    procedure DBGridOutGoingView();
    procedure N3Click(Sender: TObject);
    procedure N4Click(Sender: TObject);
    procedure N6Click(Sender: TObject);
    procedure N7Click(Sender: TObject);
    procedure N8Click(Sender: TObject);

  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  FormLetters: TFormLetters;
  MySQLQueryLetters: TMySQLQuery;
  DataSourceOutGoing : TDataSource;
  Count,CountIn,SelectRowOutGoing,SelectRowOutGoingFile : String;

implementation

{$R *.dfm}


procedure TFormLetters.ButtonIncomingClick(Sender: TObject);
 var
   WND:HWND;
   Tip:integer;
   strDate,strTime : String;
begin
   WND:=FormLetters.Handle;
   Tip:=MB_YESNO+MB_ICONINFORMATION+MB_DEFBUTTON1;
   case MessageBox(Wnd,'Вы действительно хотите добавить новую запись?','Окно предупреждения',Tip) of
     IDYES:
     begin
     strTime := FormatDateTime('hh:mm',Now);
     strDate := FormatDateTime('yyyy-mm-dd', Now);
     MySQLQueryLetters := TMySQLQuery.Create(Application);
     MySQLQueryLetters.Database := MySQLDatabaseLetters;
     MySQLQueryLetters.SQL.Text := 'INSERT INTO `listIncomingMails` '+
     ' ( ListOutgoingMailsID,ShortEssence,DateAdd,TimeAdd,StatusMailsID,Visible ) VALUES '+
     ' (NULL, 1,'''+StrDate+''','''+StrTime+''', 1, 1); SELECT LAST_INSERT_ID()';
     MySQLQueryLetters.Open;
     UnitLettersChange.NewID := MySQLQueryLetters.Fields[0].AsString;



     UnitLettersChange.Variant := 1;
     FormLettersChange.Create;
     FormLettersChange.ShowModal;
     end;

   end;


end;

procedure TFormLetters.ButtonOutGoingClick(Sender: TObject);
var
   WND:HWND;
   Tip:integer;
   strDate,strTime : String;
begin
   WND:=FormLetters.Handle;
   Tip:=MB_YESNO+MB_ICONINFORMATION+MB_DEFBUTTON1;
   case MessageBox(Wnd,'Вы действительно хотите добавить новую запись?','Окно предупреждения',Tip) of
     IDYES:
     begin
     strTime := FormatDateTime('hh:mm',Now);
     strDate := FormatDateTime('yyyy-mm-dd', Now);
     MySQLQueryLetters := TMySQLQuery.Create(Application);
     MySQLQueryLetters.Database := MySQLDatabaseLetters;
     MySQLQueryLetters.SQL.Text := 'INSERT INTO `listoutgoingmails` '+
     ' ( ListOutgoingMailsID,ShortEssence,DateAdd,TimeAdd,StatusMailsID,Visible ) VALUES '+
     ' (NULL, 1,'''+StrDate+''','''+StrTime+''', 1, 1); SELECT LAST_INSERT_ID()';
     MySQLQueryLetters.Open;
     UnitLettersChange.NewID := MySQLQueryLetters.Fields[0].AsString;



     UnitLettersChange.Variant := 0;
     FormLettersChange.Create;
     FormLettersChange.ShowModal;
     end;

   end;


end;



procedure TFormLetters.ComboBoxOutGoingChange(Sender: TObject);
begin
    ListOutGoingView();
end;

procedure TFormLetters.DBGridOutgoingCellClick(Column: TColumn);
begin
    OutGoingFileView();
end;


procedure TFormLetters.OutGoingFileView();
begin
   SelectRowOutGoing := DBGridOutGoing.DataSource.DataSet.Fields.Fields[0].Value;
   MySQLQueryLetters := TMySQLQuery.Create(Application);
   MySQLQueryLetters.Database := MySQLDatabaseLetters;
   MySQLQueryLetters.SQL.Text := 'SELECT FileName FROM listfiles WHERE '+
   ' TableID = '+SelectRowOutGoing +' AND Visible = 1 AND FileType = 0 ';
   MySQLQueryLetters.Active := true;

   DataSourceOutGoingFile.DataSet := MySQLQueryLetters;
   DbGridOutGoingFile.Columns[0].Width := 315;
   DbGridOutGoingFile.Columns[0].Title.Caption := 'Имя файла';
end;
procedure TFormLetters.EditoutGoingSearchChange(Sender: TObject);
begin
     MySQLQueryLetters := TMySQLQuery.Create(Application);
   MySQLQueryLetters.Database := MySQLDatabaseLetters;
   MySQLQueryLetters.SQL.Text := 'SELECT listoutgoingmails.ListOutgoingMailsID, ShortEssence, ' +
   ' DateAdd, TimeAdd, StatusMails FROM listoutgoingmails '+
   ' INNER JOIN ListStatusMails ON StatusMailsID = ' +
   ' ListStatusMails.ListStatusMailsID  ' +
   ' WHERE listoutgoingmails.Visible = 1 AND ShortEssence LIKE '+#39+EditOutGoingSearch.Text+'%'+#39+
   ' ORDER BY ListOutgoingMailsID DESC '+count+' ';
   MySQLQueryLetters.Active := true;
   DataSourceOutGoing.DataSet := MySQLQueryLetters;
   DBGridOutgoingView();
end;

procedure TFormLetters.FormCreate(Sender: TObject);
begin

    ListOutGoingView();
end;



procedure TFormLetters.DBGridOutGoingView();
begin
   DbGridOutGoing.Columns[0].Width := 50;
   DbGridOutGoing.Columns[0].Title.Caption := 'Номер';
   DbGridOutGoing.Columns[1].Width := 300;
   DbGridOutGoing.Columns[1].Title.Caption := 'Краткая суть письма';
   DbGridOutGoing.Columns[2].Width := 100;
   DbGridOutGoing.Columns[2].Title.Caption := 'Дата';
   DbGridOutGoing.Columns[3].Width := 70;
   DbGridOutGoing.Columns[3].Title.Caption := 'Время';
   DbGridOutGoing.Columns[4].Width := 220;
   DbGridOutGoing.Columns[4].Title.Caption := 'Статус';
end;

procedure TFormLetters.ListOutGoingView();
begin
   if ComboBoxOutGoing.Text <> 'Все' then Count := 'LIMIT '+ComboBoxOutGoing.Text
   else count := '';

   MySQLQueryLetters := TMySQLQuery.Create(Application);
   MySQLQueryLetters.Database := MySQLDatabaseLetters;
   MySQLQueryLetters.SQL.Text := 'SELECT listoutgoingmails.ListOutgoingMailsID, ShortEssence, ' +
   ' DateAdd, TimeAdd, StatusMails FROM listoutgoingmails '+
   ' INNER JOIN ListStatusMails ON StatusMailsID = ' +
   ' ListStatusMails.ListStatusMailsID ' +
   ' WHERE listoutgoingmails.Visible = 1 ' +
   ' ORDER BY ListOutgoingMailsID DESC '+count+' ';
   MySQLQueryLetters.Active := true;

   DataSourceOutGoing.DataSet := MySQLQueryLetters;
   DBGridOutGoingView();


end;

procedure TFormLetters.ListIncomingView();
begin
   if ComboBoxIncoming.Text <> 'Все' then Count := 'LIMIT '+ComboBoxIncoming.Text
   else countIn := '';

   MySQLQueryLetters := TMySQLQuery.Create(Application);
   MySQLQueryLetters.Database := MySQLDatabaseLetters;
   MySQLQueryLetters.SQL.Text := 'SELECT listIncomingmails.ListIncomingMailsID, ShortEssence, ' +
   ' DateAdd, TimeAdd, StatusMails FROM listIncomingmails '+
   ' INNER JOIN ListStatusMails ON StatusMailsID = ' +
   ' ListStatusMails.ListStatusMailsID ' +
   ' WHERE listIncomingmails.Visible = 1 ' +
   ' ORDER BY ListIncomingMailsID DESC '+countIn+' ';
   MySQLQueryLetters.Active := true;

   DataSourceIncoming.DataSet := MySQLQueryLetters;
   DBGridIncomingView();


end;

procedure TFormLetters.DBGridIncomingView();
begin
   DbGridIncoming.Columns[0].Width := 50;
   DbGridIncoming.Columns[0].Title.Caption := 'Номер';
   DbGridIncoming.Columns[1].Width := 300;
   DbGridIncoming.Columns[1].Title.Caption := 'Краткая суть письма';
   DbGridIncoming.Columns[2].Width := 100;
   DbGridIncoming.Columns[2].Title.Caption := 'Дата';
   DbGridIncoming.Columns[3].Width := 70;
   DbGridIncoming.Columns[3].Title.Caption := 'Время';
   DbGridIncoming.Columns[4].Width := 220;
   DbGridIncoming.Columns[4].Title.Caption := 'Статус';
end;


procedure TFormLetters.N1Click(Sender: TObject);
var
   WND:HWND;
   Tip:integer;
begin
   SelectRowOutGoing := DBGridOutGoing.DataSource.DataSet.Fields.Fields[0].Value;
   WND:=FormLetters.Handle;
   Tip:=MB_YESNO+MB_ICONINFORMATION+MB_DEFBUTTON1;

     case MessageBox(Wnd,'Вы действительно хотите удалить письмо ?',
     'Предупреждение',Tip) of
       IDYES:
         begin
           MySQLQueryLetters := TMySQLQuery.Create(Application);
           MySQLQueryLetters.Database := FormLetters.MySQLDatabaseLetters;
           MySQLQueryLetters.SQL.Text := 'UPDATE `listoutgoingmails` SET `Visible` = 0 WHERE'+
           ' `listoutgoingmails`.`ListOutgoingMailsID` = '''+SelectRowOutGoing+''' ';
           MySQLQueryLetters.ExecSQL;
           ListOutGoingView();

         end;
     end;




end;

procedure TFormLetters.N2Click(Sender: TObject);
begin

SelectRowOutGoing := DBGridOutGoing.DataSource.DataSet.Fields.Fields[0].Value;

   MySQLQueryLetters := TMySQLQuery.Create(Application);
   MySQLQueryLetters.Database := MySQLDatabaseLetters;
   MySQLQueryLetters.SQL.Text := ' SELECT ListOutgoingMailsID,ShortEssence ' +
   ' FROM `listoutgoingmails` WHERE ListOutgoingMailsID = '+SelectRowOutGoing;
   MySQLQueryLetters.Active := true;


   UnitLettersChange.Variant := 0;
   UnitLettersChange.NewID := SelectRowOutGoing;
   FormLettersChange.Create();
   UnitLettersChange.LabeledEditTittle.Text :=
   MySQLQueryLetters.FieldByName('ListOutgoingMailsID').AsString;
   UnitLettersChange.MemoContent.Text :=
   MySQLQueryLetters.FieldByName('ShortEssence').AsString;


   FormLettersChange.ShowModal;

end;

procedure TFormLetters.N3Click(Sender: TObject);
var
   WND:HWND;  NameFile:String;
   Tip:integer;
begin
   SelectRowOutGoing := DBGridOutGoing.DataSource.DataSet.Fields.Fields[0].Value;
   WND:=FormLetters.Handle;
   Tip:=MB_YESNO+MB_ICONINFORMATION+MB_DEFBUTTON1;
     case MessageBox(Wnd,'Вы действительно хотите удалить файл ?',
     'Предупреждение',Tip) of
       IDYES:
         begin       // deletyed
         SelectRowOutGoingFile := DBGridOutGoingFile.DataSource.DataSet.Fields.Fields[0].Value;

         MySQLQueryLetters := TMySQLQuery.Create(Application);
         MySQLQueryLetters.Database := FormLetters.MySQLDatabaseLetters;
         MySQLQueryLetters.SQL.Text := 'UPDATE `listfiles` SET `Visible` = 0 WHERE' +
         ' FileName = '''+SelectRowOutGoingFile+''' ';
         MySQLQueryLetters.ExecSQL;
         end;


     end;
     OutGoingFileView();
end;

procedure TFormLetters.N4Click(Sender: TObject);
var idFTP : TidFTP;
SaveDialog : TSaveDialog;
begin

    SelectRowOutGoingFile := DBGridOutGoingFile.DataSource.DataSet.Fields.Fields[0].Value;

    idFTP:=TidFTP.Create(nil);
    idFTP.Host:='135.181.40.238';
    idFTP.Username:='romashka';
    idFTP.Password:='romashka1234';

     idFTP.Connect;
     SaveDialog := TSaveDialog.Create(self);
      SaveDialog.FileName := SelectRowOutGoingFile;
      SaveDialog.Execute;

     if idFTP.Connected then
      try
       idFTP.Get(SelectRowOutGoingFile,SaveDialog.Files.Strings[0],true);

      except

      end;

end;

procedure TFormLetters.N6Click(Sender: TObject);
begin
OutGoingChangeStatus(1);
end;

procedure TFormLetters.N7Click(Sender: TObject);
begin
OutGoingChangeStatus(2);
end;

procedure TFormLetters.N8Click(Sender: TObject);
begin
OutGoingChangeStatus(3);
end;

procedure  TFormLetters.OutGoingChangeStatus(number : integer);
begin

   SelectRowOutGoing := DBGridOutGoing.DataSource.DataSet.Fields.Fields[0].Value;

   MySQLQueryLetters := TMySQLQuery.Create(Application);
   MySQLQueryLetters.Database := FormLetters.MySQLDatabaseLetters;
   MySQLQueryLetters.SQL.Text := 'UPDATE `listoutgoingmails` SET '+
   '`StatusMailsID` =  ''' + IntToStr(number) + ''' ' +
   ' WHERE `ListOutgoingMailsID` = ''' + SelectRowOutGoing + ''' ';
   MySQLQueryLetters.ExecSQL;

   ListOutGoingView();

end;

end.
